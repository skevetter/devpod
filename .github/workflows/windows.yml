name: Windows Docker Test

on:
  push:
    branches: [main]
  workflow_dispatch:
  pull_request:

jobs:
  docker-windows:
    name: Docker on Windows
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v6

      - name: setup WSL
        uses: Vampire/setup-wsl@v6
        with:
          distribution: Ubuntu-24.04

      - name: install and start docker in WSL
        shell: pwsh
        run: |
          # Stop Windows Docker service
          Stop-Service docker -ErrorAction SilentlyContinue

          Write-Host "Installing Docker in WSL"
          wsl --distribution Ubuntu-24.04 --exec sudo apt update
          wsl --distribution Ubuntu-24.04 --exec sudo apt-get install docker.io -y

          # Configure dockerd to listen on TCP
          wsl --distribution Ubuntu-24.04 --exec sudo mkdir -p /etc/systemd/system/docker.service.d
          wsl --distribution Ubuntu-24.04 --exec sudo bash -c 'echo "[Service]" > /etc/systemd/system/docker.service.d/override.conf'
          wsl --distribution Ubuntu-24.04 --exec sudo bash -c 'echo "ExecStart=" >> /etc/systemd/system/docker.service.d/override.conf'
          wsl --distribution Ubuntu-24.04 --exec sudo bash -c 'echo "ExecStart=/usr/bin/dockerd -H unix:///var/run/docker.sock -H tcp://0.0.0.0:2375" >> /etc/systemd/system/docker.service.d/override.conf'

          wsl --distribution Ubuntu-24.04 --exec sudo service docker start
          Start-Sleep -Seconds 5

          wsl.exe -l -v
          wsl.exe --set-default Ubuntu-24.04

          # Set environment for subsequent steps
          echo "DOCKER_HOST=tcp://127.0.0.1:2375" >> $env:GITHUB_ENV
          echo "DOCKER_DEFAULT_PLATFORM=linux/amd64" >> $env:GITHUB_ENV

          # Validate docker is working
          Write-Host "DOCKER_HOST=$env:DOCKER_HOST"
          docker version
          docker info | Select-String -Pattern "OSType"
          docker pull hello-world
          docker run --rm hello-world
          docker pull mcr.microsoft.com/devcontainers/base:ubuntu
          Write-Host "Docker validation successful!"
