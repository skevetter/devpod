name: Windows Docker Test

on:
  push:
    branches: [main]
  workflow_dispatch:
  pull_request:

jobs:
  docker-windows:
    name: Docker on Windows
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v6

      - name: setup WSL
        uses: Vampire/setup-wsl@v6
        with:
          distribution: Ubuntu-24.04
          wsl-conf: |
            [wsl2]
            networkingMode=mirrored

      - name: install and start docker in WSL
        shell: pwsh
        run: |
          # Stop Windows Docker service
          Stop-Service docker -ErrorAction SilentlyContinue

          Write-Host "Installing Docker in WSL"
          wsl --distribution Ubuntu-24.04 --exec sudo apt update
          wsl --distribution Ubuntu-24.04 --exec sudo apt-get install docker.io -y

          docker run --rm hello-world || echo "Ignoring docker run failure"
          docker pull mcr.microsoft.com/devcontainers/base:ubuntu || echo "Ignoring docker pull failure"

          # Stop docker service and socket
          wsl --distribution Ubuntu-24.04 --exec sudo service docker stop
          wsl --distribution Ubuntu-24.04 --exec sudo systemctl stop docker.socket

          # Start dockerd directly with TCP enabled
          wsl --distribution Ubuntu-24.04 --exec sudo bash -c 'nohup dockerd -H unix:///var/run/docker.sock -H tcp://0.0.0.0:2375 > /tmp/dockerd.log 2>&1 &'
          Start-Sleep -Seconds 10

          # Check if dockerd is running
          wsl --distribution Ubuntu-24.04 --exec ps aux | grep dockerd
          wsl --distribution Ubuntu-24.04 --exec sudo ss -tlnp | grep 2375

          wsl.exe -l -v
          wsl.exe --set-default Ubuntu-24.04

          # Set environment for current session AND subsequent steps
          $env:DOCKER_HOST = "tcp://127.0.0.1:2375"
          $env:DOCKER_DEFAULT_PLATFORM = "linux/amd64"
          echo "DOCKER_HOST=tcp://127.0.0.1:2375" >> $env:GITHUB_ENV
          echo "DOCKER_DEFAULT_PLATFORM=linux/amd64" >> $env:GITHUB_ENV

          # Validate docker is working
          Write-Host "DOCKER_HOST=$env:DOCKER_HOST"
          docker version
          docker info | Select-String -Pattern "OSType"
          docker pull hello-world
          docker run --rm hello-world
          docker pull mcr.microsoft.com/devcontainers/base:ubuntu
