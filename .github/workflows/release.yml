name: Release
on:
  release:
    types: [prereleased]
  workflow_dispatch:
    inputs:
      dry_run:
        description: "run as dry run (creates draft release for testing)"
        required: true
        type: boolean
        default: true
      auto_cleanup:
        description: "cleanup release after dry run"
        required: true
        type: boolean
        default: false

jobs:
  create-release:
    name: Create Release
    permissions:
      contents: write
    runs-on: ubuntu-latest
    outputs:
      package_version: ${{ steps.create-release.outputs.package_version }}
      original_package_version: ${{ steps.create-release.outputs.original_package_version }}
      release_id: ${{ steps.create-release.outputs.release_id }}
      is_dry_run: ${{ steps.check-mode.outputs.is_dry_run }}
    steps:
      - uses: actions/checkout@v6

      - name: check mode
        id: check-mode
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ inputs.dry_run }}" == "true" ]]; then
            echo "is_dry_run=true" >> "$GITHUB_OUTPUT"
          elif [[ "${{ github.event_name }}" == "release" ]]; then
            if [[ ! "${{ github.ref }}" =~ ^refs/tags/v ]]; then
              echo "Error: Production release must be triggered by a tag starting with 'v'"
              exit 1
            fi
            echo "is_dry_run=false" >> "$GITHUB_OUTPUT"
          else
            echo "Error: Invalid workflow trigger"
            exit 1
          fi

      - name: create draft release for dry run
        if: steps.check-mode.outputs.is_dry_run == 'true'
        id: create-draft
        uses: actions/github-script@v8
        with:
          script: |
            const release = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: 'v0.0.0-10',
              name: 'Test Release (Dry Run)',
              draft: true,
              prerelease: true,
              body: 'Automated dry run test release'
            })

            core.setOutput('package_version', '0.0.0-10')
            core.setOutput('original_package_version', '0.0.0-10')
            core.setOutput('release_id', release.data.id)

      - name: get release from tag
        if: steps.check-mode.outputs.is_dry_run == 'false'
        uses: ./.github/actions/create-release
        id: create-tag-release

      - name: set outputs
        id: create-release
        run: |
          if [[ "${{ steps.check-mode.outputs.is_dry_run }}" == "true" ]]; then
            {
              echo "package_version=${{ steps.create-draft.outputs.package_version }}"
              echo "original_package_version=${{ steps.create-draft.outputs.original_package_version }}"
              echo "release_id=${{ steps.create-draft.outputs.release_id }}"
            } >> "$GITHUB_OUTPUT"
          else
            {
              echo "package_version=${{ steps.create-tag-release.outputs.package_version }}"
              echo "original_package_version=${{ steps.create-tag-release.outputs.original_package_version }}"
              echo "release_id=${{ steps.create-tag-release.outputs.release_id }}"
            } >> "$GITHUB_OUTPUT"
          fi

  build-linux:
    name: Build Linux Release Artifacts ${{ matrix.settings.target }}
    needs: [create-release]
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        settings:
          - target: x86_64-unknown-linux-gnu
            arch: amd64
            cli_only: false
          - target: aarch64-unknown-linux-gnu
            arch: arm64
            cli_only: true
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: setup build environment
        uses: ./.github/actions/setup-build-environment
        with:
          host: ubuntu-latest
          target: ${{ matrix.settings.target }}
          package_version: ${{ needs.create-release.outputs.package_version }}
          cli_only: ${{ matrix.settings.cli_only }}
          cache-key-suffix: "relase-linux-${{ github.run_id }}"

      - name: build CLI
        uses: ./.github/actions/build-cli
        with:
          host: ubuntu-latest
          target: ${{ matrix.settings.target }}
          os: linux
          arch: ${{ matrix.settings.arch }}
          version: ${{ needs.create-release.outputs.original_package_version }}
          telemetry_private_key: ${{ secrets.DEVPOD_TELEMETRY_PRIVATE_KEY }}
          crane_private_key: ${{ secrets.CRANE_PRIVATE_KEY }}
          output_path: release
          sidecar_path: desktop/src-tauri/bin

      - name: build desktop app
        if: matrix.settings.target == 'x86_64-unknown-linux-gnu'
        uses: tauri-apps/tauri-action@v0.6
        with:
          releaseId: ${{ needs.create-release.outputs.release_id }}
          projectPath: ./desktop
          args: --target ${{ matrix.settings.target }} --config src-tauri/tauri-flatpak.conf.json --bundles appimage,deb,updater
          includeUpdaterJson: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}

      - name: create linux release artifacts
        if: matrix.settings.cli_only == false
        uses: ./.github/actions/create-linux-release-artifacts
        with:
          target: ${{ matrix.settings.target }}
          package_version: ${{ needs.create-release.outputs.package_version }}
          release_id: ${{ needs.create-release.outputs.release_id }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          tauri_private_key: ${{ secrets.TAURI_PRIVATE_KEY }}
          tauri_key_password: ${{ secrets.TAURI_KEY_PASSWORD }}
          app_image_sign: ${{ secrets.APP_IMAGE_SIGN }}
          app_image_sign_key: ${{ secrets.APP_IMAGE_SIGN_KEY }}
          app_image_sign_passphrase: ${{ secrets.APP_IMAGE_SIGN_PASSPHRASE }}

      - name: upload CLI asset
        uses: ./.github/actions/upload-cli-asset
        with:
          target: ${{ matrix.settings.target }}
          os: linux
          arch: ${{ matrix.settings.arch }}
          release_id: ${{ needs.create-release.outputs.release_id }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

  build-macos:
    name: Build MacOS Release Artifacts ${{ matrix.settings.target }}
    needs: [create-release, build-linux]
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        settings:
          - target: x86_64-apple-darwin
            arch: amd64
          - target: aarch64-apple-darwin
            arch: arm64
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v6

      - name: setup build environment
        uses: ./.github/actions/setup-build-environment
        with:
          host: macos-latest
          target: ${{ matrix.settings.target }}
          package_version: ${{ needs.create-release.outputs.package_version }}
          cli_only: false
          cache-key-suffix: "release-macos-${{ github.run_id }}"

      - name: build CLI
        uses: ./.github/actions/build-cli
        with:
          host: macos-latest
          target: ${{ matrix.settings.target }}
          os: darwin
          arch: ${{ matrix.settings.arch }}
          version: ${{ needs.create-release.outputs.original_package_version }}
          telemetry_private_key: ${{ secrets.DEVPOD_TELEMETRY_PRIVATE_KEY }}
          crane_private_key: ${{ secrets.CRANE_PRIVATE_KEY }}
          output_path: release
          sidecar_path: desktop/src-tauri/bin

      - name: create macOS release artifacts
        uses: ./.github/actions/create-macos-release-artifacts
        with:
          target: ${{ matrix.settings.target }}
          release_id: ${{ needs.create-release.outputs.release_id }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          tauri_private_key: ${{ secrets.TAURI_PRIVATE_KEY }}
          tauri_key_password: ${{ secrets.TAURI_KEY_PASSWORD }}

      - name: upload CLI asset
        uses: ./.github/actions/upload-cli-asset
        with:
          target: ${{ matrix.settings.target }}
          os: darwin
          arch: ${{ matrix.settings.arch }}
          release_id: ${{ needs.create-release.outputs.release_id }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

  build-windows:
    name: Build Windows Release Artifacts windows-x86_64-pc-windows-msvc
    needs: [create-release, build-linux]
    permissions:
      contents: write
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v6

      - name: setup build environment
        uses: ./.github/actions/setup-build-environment
        with:
          host: windows-latest
          target: x86_64-pc-windows-msvc
          package_version: ${{ needs.create-release.outputs.package_version }}
          cli_only: false
          cache-key-suffix: "build-windows-${{ github.run_id }}"

      - name: build CLI
        uses: ./.github/actions/build-cli
        with:
          host: windows-latest
          target: x86_64-pc-windows-msvc
          os: windows
          arch: amd64
          version: ${{ needs.create-release.outputs.original_package_version }}
          telemetry_private_key: ${{ secrets.DEVPOD_TELEMETRY_PRIVATE_KEY }}
          crane_private_key: ${{ secrets.CRANE_PRIVATE_KEY }}
          output_path: release
          sidecar_path: desktop/src-tauri/bin

      - name: create windows release artifacts
        uses: ./.github/actions/create-windows-release-artifacts
        with:
          target: x86_64-pc-windows-msvc
          arch: amd64
          package_version: ${{ needs.create-release.outputs.package_version }}
          release_id: ${{ needs.create-release.outputs.release_id }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          tauri_private_key: ${{ secrets.TAURI_PRIVATE_KEY }}
          tauri_key_password: ${{ secrets.TAURI_KEY_PASSWORD }}

  publish:
    name: Publish Release
    needs: [create-release, build-linux, build-macos, build-windows]
    if: needs.create-release.outputs.is_dry_run == 'false'
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: release pro provider
        uses: ./.github/actions/release-pro-provider
        with:
          version: v${{ needs.create-release.outputs.original_package_version }}
          github_token: ${{ github.token }}

      - name: update latest.json
        uses: ./.github/actions/update-latest-json
        with:
          release_id: ${{ needs.create-release.outputs.release_id }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

  cleanup:
    name: Cleanup Draft Release
    needs: [create-release, build-linux, build-macos, build-windows]
    if: always() && needs.create-release.outputs.is_dry_run == 'true' && inputs.auto_cleanup
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v8
        with:
          script: |
            await github.rest.repos.deleteRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: "${{ needs.create-release.outputs.release_id }}"
            })
            console.log("Deleted release: ${{ needs.create-release.outputs.release_id }}")
