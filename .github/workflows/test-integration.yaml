name: Test Integration Local

on:
  workflow_dispatch:
  pull_request:

jobs:
  test-integration:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Build binary
        run: |
          mkdir -p ./e2e/bin
          CGO_ENABLED=0 go build -o ./e2e/bin/devpod-linux-amd64
          chmod +x ./e2e/bin/devpod-linux-amd64
          ls -lh ./e2e/bin/
          file ./e2e/bin/devpod-linux-amd64

      - name: Run integration test
        working-directory: ./e2e
        run: |
          echo "=== Running integration tests ==="
          echo "Working directory: $(pwd)"
          echo "Binary location: $(ls -lh bin/)"
          sudo go test -v -ginkgo.v -timeout 600s --ginkgo.label-filter=up-docker-build
          sudo go test -v -ginkgo.v -timeout 600s --ginkgo.label-filter=up-docker-build-compose
